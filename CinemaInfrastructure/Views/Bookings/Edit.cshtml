@model CinemaDomain.Model.Booking
@{
    ViewData["Title"] = "Змінити бронювання";
}
<h1>Змінити бронювання</h1>

<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" name="viewerId" value="@Model.ViewerId" />
            <input type="hidden" name="sessionId" value="@Model.SessionId" />
            <input type="hidden" name="seatId" value="@Model.SeatId" />

            <div class="form-group">
                <label>Фільм</label>
                <input type="text" class="form-control" value="@Model.Session.Film.Name" readonly />
                <input type="hidden" id="FilmId" value="@Model.Session.FilmId" />
            </div>
            <div class="form-group">
                <label for="SessionTime">Час сеансу</label>
                <select id="SessionTime" name="newSessionId" asp-items="@(ViewBag.SessionTime as SelectList)" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="RowSelect">Ряд</label>
                <select id="RowSelect" class="form-control">
                    <option value="">Оберіть ряд</option>
                    @{
                        var initialRow = ViewBag.InitialRow != null ? ViewBag.InitialRow.ToString() : "";
                    }
                    @if (!string.IsNullOrEmpty(initialRow))
                    {
                        @:
                        <option value="@initialRow" selected="selected">@initialRow</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label for="SeatId">Місце</label>
                <select id="SeatId" name="newSeatId" class="form-control">
                    <option value="">Оберіть місце</option>
                    @if (ViewBag.Seats != null)
                    {
                        foreach (var seat in (SelectList)ViewBag.Seats)
                        {
                            if (seat.Value == Model.SeatId.ToString())
                            {
                                <option value="@seat.Value" selected="selected">@seat.Text</option>
                            }
                            else
                            {
                                <option value="@seat.Value">@seat.Text</option>
                            }
                        }
                    }
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Зберегти</button>
        </form>
        <div>
            <a asp-action="Index">Назад</a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            function resetRowsAndSeats() {
                $("#RowSelect").empty().append('<option value="">Оберіть ряд</option>');
                $("#SeatId").empty().append('<option value="">Оберіть місце</option>');
            }
            function loadRowsAndSeats(sessionId, selectedRow) {
                if (sessionId) {
                    $.ajax({
                        url: '@Url.Action("GetRowsBySession", "Bookings")',
                        data: { sessionId: sessionId },
                        success: function (rows) {
                            resetRowsAndSeats();
                            $.each(rows, function (i, row) {
                                var isSelected = (row == selectedRow) ? " selected=\"selected\"" : "";
                                $("#RowSelect").append('<option value="' + row + '"' + isSelected + '>' + row + '</option>');
                            });
                            if (selectedRow) {
                                loadSeats(sessionId, selectedRow);
                            }
                        },
                        error: function () {
                            resetRowsAndSeats();
                        }
                    });
                } else {
                    resetRowsAndSeats();
                }
            }
            function loadSeats(sessionId, row) {
                if (sessionId && row) {
                    $.ajax({
                        url: '@Url.Action("GetSeatsByRow", "Bookings")',
                        data: { sessionId: sessionId, row: row },
                        success: function (seats) {
                            $("#SeatId").empty().append('<option value="">Оберіть місце</option>');
                            $.each(seats, function (i, seat) {
                                var isSelected = (seat.id == '@Model.SeatId') ? " selected=\"selected\"" : "";
                                $("#SeatId").append('<option value="' + seat.id + '"' + isSelected + '>' + seat.numberInRow + '</option>');
                            });
                        },
                        error: function () {
                            $("#SeatId").empty().append('<option value="">Оберіть місце</option>');
                        }
                    });
                } else {
                    $("#SeatId").empty().append('<option value="">Оберіть місце</option>');
                }
            }

            // При зміні часу сеансу очищаємо ряди і місця, потім завантажуємо нові
            $("#SessionTime").change(function () {
                var sessionId = $(this).val();
                resetRowsAndSeats();
                loadRowsAndSeats(sessionId, null);
            });
            // При зміні ряду завантажуємо відповідні місця
            $("#RowSelect").change(function () {
                var sessionId = $("#SessionTime").val();
                var row = $(this).val();
                loadSeats(sessionId, row);
            });
            // При завантаженні сторінки завантажуємо ряди і місця для початкових значень
            loadRowsAndSeats('@Model.SessionId', '@Model.Seat.Row');
        });
    </script>
}
