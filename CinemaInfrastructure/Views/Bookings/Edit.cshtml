@model CinemaDomain.Model.Booking

@{
    ViewData["Title"] = "Edit";
}

<h1>Змінити бронювання (змінити місце)</h1>
<div class="row">
    <div class="col-md-4">
<form asp-action="Edit" method="post">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <input type="hidden" name="viewerId" value="@Model.ViewerId" />
        <input type="hidden" name="sessionId" value="@Model.SessionId" />
        <input type="hidden" name="seatId" value="@Model.SeatId" />

    <div class="form-group">
        <label for="FilmName">Фільм</label>
        <input type="text" id="FilmName" class="form-control" value="@Model.Session.Film.Name" readonly />
        <input type="hidden" id="FilmId" value="@Model.Session.FilmId" />
    </div>
        <div class="form-group">
        <label for="SessionTime">Час сеансу</label>
        <select id="SessionTime" name="newSessionId" class="form-control">
                    <option value="@Model.SessionId" selected>@Model.Session.SessionTime.ToString("dd.MM.yyyy HH:mm")</option>
            @foreach (var session in ViewBag.Sessions)
            {
                if (session.Id != Model.SessionId)
                {
                    <option value="@session.Id">@Convert.ToDateTime(session.SessionTime).ToString("dd.MM.yyyy HH:mm")</option>
                }
            }
        </select>
    </div>
            <div class="form-group">
                <label for="RowSelect">Ряд</label>
                <select id="RowSelect" class="form-control">
                    <option value="@Model.Seat.Row">@Model.Seat.Row</option>
                </select>
            </div>
            <div class="form-group">
                <label for="SeatId">Місце</label>
                <select id="SeatId" name="newSeatId" class="form-control">
                    <option value="@Model.SeatId">@Model.Seat.NumberInRow</option>
                </select>
            </div>

    <button type="submit" class="btn btn-primary">Зберегти</button>
</form>
    </div>
</div>


<a asp-action="Index">Назад</a>


@section Scripts {
    <script>
                $(document).ready(function () {
            function resetRowsAndSeats() {
                $("#RowSelect").empty().append('<option value="">Оберіть ряд</option>');
                $("#SeatId").empty().append('<option value="">Оберіть місце</option>');
            }

            function loadRowsAndSeats(sessionId, selectedRow) {
                if (sessionId) {
                    $.ajax({
                        url: '@Url.Action("GetRowsBySession", "Bookings")',
                        data: { sessionId: sessionId },
                        success: function (rows) {
                            resetRowsAndSeats();
                            $.each(rows, function (i, row) {
                                var isSelected = (row == selectedRow) ? " selected" : "";
                                $("#RowSelect").append('<option value="' + row + '"' + isSelected + '>' + row + '</option>');
                            });

                            // Якщо є вибраний ряд, підтягуємо доступні місця
                            if (selectedRow) {
                                loadSeats(sessionId, selectedRow);
                            }
                        }
                    });
                } else {
                    resetRowsAndSeats();
                }
            }

            function loadSeats(sessionId, row) {
                if (sessionId && row) {
                    $.ajax({
                        url: '@Url.Action("GetSeatsByRow", "Bookings")',
                        data: { sessionId: sessionId, row: row },
                        success: function (seats) {
                            $("#SeatId").empty().append('<option value="">Оберіть місце</option>');
                            $.each(seats, function (i, seat) {
                                var isSelected = (seat.id == '@Model.SeatId') ? " selected" : "";
                                $("#SeatId").append('<option value="' + seat.id + '"' + isSelected + '>' + seat.numberInRow + '</option>');
                            });
                        }
                    });
                } else {
                    $("#SeatId").empty().append('<option value="">Оберіть місце</option>');
                }
            }

            $("#SessionTime").change(function () {
                var sessionId = $(this).val();
                loadRowsAndSeats(sessionId, null);
            });

            $("#RowSelect").change(function () {
                var sessionId = $("#SessionTime").val();
                var row = $(this).val();
                loadSeats(sessionId, row);
            });

            // Завантажуємо ряди та місця при завантаженні сторінки
            loadRowsAndSeats('@Model.SessionId', '@Model.Seat.Row');
        });
    </script>
}

